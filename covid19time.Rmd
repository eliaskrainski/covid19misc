---
title: "Visualização temporal de dados de COVID19."
author: "Elias T Krainski"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
l0 <- log(c(1, 3), 10)
ll <- vector('list', 5)
ll[[5]]$y <- c(rep(-8:-1, each=2)-rev(l0), -l0[2], 
               -0.15, 0, 0.15, l0[2],
               rep(1:8, each=2)+l0)
ll[[5]]$l <- paste0(c(rep(c(-300, -100, -30, -10, -3, -1), 3), 0, 
                    rep(c(1, 3, 10,30, 100,300), 3)), 
                    rep(c('M', 'K', '', 'K', 'M'), c(6, 6, 13, 6, 6)))
ll[[4]] <- lapply(ll[[5]], function(x) x[seq(2, length(x), 2)])
ll[[3]] <- lapply(ll[[5]], function(x) x[seq(1, length(x), 3)])
l0 <- log(c(1, 2, 5), 10)
ll[[2]] <- list(y=c(rep(-8:-1, each=3)-rev(l0), 
                -l0[3:2], -0.15, 0, 0.15, l0[2:3],
                rep(1:8, each=3)+l0))
ll0 <- c(1, 2, 5, 10, 20, 50, 100, 200, 500)
ll[[2]]$l <- paste0(c(rep(-rev(ll0), 3), 0, rep(ll0, 3)), 
                    rep(c('M', 'K', '', 'K', 'M'), 
                    c(9, 9, 19, 9, 9)))
library(mgcv)
if (file.exists('data/wdl.RData')) {
  load('data/wdl.RData') 
} else {
  source('rcode/wdata-update.R')
}
cn <- colnames(wdl[[1]])
Date <- as.Date(cn[7:length(cn)], 'X%Y%m%d')
lastday <- tail(Date, 1)
if (lastday<(Sys.Date()-1)) {
  source('rcode/wdata-update.R')
  cn <- colnames(wdl[[1]])
  Date <- as.Date(cn[7:length(cn)], 'X%Y%m%d')
  lastday <- tail(Date, 1)
}
wc.names <- levels(wdl[[1]]$Country.Region)
st.names <- levels(wdl[[1]]$Province.State)
mu.names <- levels(wdl[[1]]$City)
```

```{r covid19time, echo=FALSE}
sidebarLayout(
  sidebarPanel(
  radioButtons("data", "Dado a ser visualizado:",
               choices=list("Casos confirmados" = 1,
                 "Obitos" = 2), 
               selected = 1),
  selectInput(inputId = 'country', 
              label = 'País', 
              choices = wc.names, 
              selected = 'Brazil'),
  selectInput(inputId = 'state', 
              label = 'Estado/Província', 
              choices = st.names, 
              selected = 'PARANÁ'),
  selectInput(inputId = 'city', 
              label = 'Cidade', 
              choices = mu.names, 
              selected = 'Curitiba'),
  dateRangeInput('dateRange',
      label = 'Data (intervalo):',
      start = as.Date('2020-01-20'), 
      end = Sys.Date() - 1, 
      format = "dd/mm/yy", 
      language = 'pt'
    ),
  checkboxInput("log10", label = "Log 10", value = TRUE),
  actionButton("Exit", "Exit")
),  
renderPlot({
  k <- as.integer(input$data)
  iic <- wdl[[k]]$Country==input$country
  iis <- wdl[[k]]$Province.State==input$state
  iim <- wdl[[k]]$City==input$city
  iicsm <- which((iic+iis+iim)==3)
  y <- as.matrix(wdl[[k]][, 7:ncol(wdl[[k]])])[iicsm[1], ]
  if (sum(y)<1) stop('Sem dados!')
  iiy <- which(y>0)[1]:length(y)
  y <- y[iiy]
  Date <- Date[iiy]
  dy <- diff(c(0, y))
  r <- dy; r[dy<0] <- 0
  s <- gam(y ~ s(x), poisson(), 
           list(x=1:length(r), y=r))$fitted
  xlm <- as.Date(input$dateRange, '%d/%m/%y')
  if (diff(xlm)<3) stop('Selecione 3 ou mais dias!')
  iip <- which((Date>=xlm[1]) & (Date<=xlm[2]))
  if (length(iip)<3) stop('Selecione 3 ou mais dias!')
  Date <- Date[iip]
  y <- y[iip]
  dy <- dy[iip]
  n.obs <- sum(dy) 
  s <- s[iip]
  ly <- log(y, 10)
  ldy <- dy  
  ldy[dy<0] <- -log(abs(dy[dy<0]), 10)
  ldy[dy==(-1)] <- -0.15
  ldy[dy==0] <- 0
  ldy[dy>0] <- log(dy[dy>0], 10)
  ldy[dy==1] <- 0.15
  if (input$log10) {
    y.plot <- ldy
    s.plot <- log(s, 10)
    s.plot[s<2] <- s[s<2]*0.15
  } else {
    y.plot <- dy
    s.plot <- s
  }
  ll[[1]] <- list(y=unique(sort(ldy))) 
  ll[[1]]$l <- 10^ll[[1]]$y
  ll[[1]]$l[ll[[1]]$y==(-0.15)] <- -1
  ll[[1]]$l[ll[[1]]$y==(0)] <- 0
  ll[[1]]$l[ll[[1]]$y==(0.15)] <- 1
  if (n.obs>9) {
     par(mfrow=c(2,2), mar=c(2, 3, 0.1, 1), mgp=c(2, 0.5, 0))
  } else {
     par(mfrow=c(1,1), mar=c(2, 3, 1, 1), mgp=c(2, 0.5, 0))
  }
  plot(Date, y.plot, pch=19, axes=FALSE, 
       xlab='', ylab=c('Casos', 'Óbitos')[k])
  axis(1, pretty(Date), format(pretty(Date), '%d %b'))
  nll <- findInterval(
      sum(findInterval(ll[[5]]$y, par()$usr[3:4])==1), 
      c(-0.5, 2.5, 9.5, 19.5, 29.5))
  if (input$log10) {
    axis(2, ll[[nll]]$y, ll[[nll]]$l, las=1)
  } else {
    axis(2, las=1)
  }
  lines(Date, s.plot, lwd=2)
  if (n.obs>9) { 
 #   plot(Date, c(NA, diff(s)), type='l', lwd=2, las=1, 
  #       xlab='', ylab='Velocidade de crescimento')  
    plot(iicsm)
    plot(Date, 100*c(NA, diff(s))/s, type='l', lwd=2, las=1,
         xlab='', ylab='Crescimento relativo (%)')  
    abline(h=0)
    plot(ly, ldy, pch=19, axes=FALSE, las=1,
         xlab='Acumulados', ylab='Novos')
    axis(2, ll[[nll]]$y, ll[[nll]]$l, las=1)
    nllx <- findInterval(
      sum(findInterval(ll[[5]]$y, par()$usr[1:2])==1),
      c(-0.5, 2.5, 9.5, 19.5, 29.5))
    if (nllx>1) {
      axis(1, ll[[nllx]]$y, ll[[nllx]]$l)
    } else {
      sx <- seq(par()$usr[1], par()$usr[2], length=5)
      l <- round(10^sx)
      axis(1, log(l, 10), l)
    }
  }
  #observe({
   #     updateSelectInput(session, "city", choices = mu.names) 
  #})  
  observe({
    if(input$Exit > 0) {
      stopApp(NULL)
    }
  })
 }, 
 width = 500, height=500
 )
)
```
