---
title: "Visualização temporal de dados de COVID19."
author: "Elias T Krainski"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mgcv)
load('data/wdl.RData')
wc.names <- unique(as.character(wdl[[1]]$Country.Region))
st.names <- unique(as.character(wdl[[1]]$Province.State)) 
cn <- colnames(wdl[[1]])
Date <- as.Date(cn[7:length(cn)], 'X%Y%m%d')
lastday <- tail(Date, 1)
if (lastday<(Sys.Date()-1))
  source('rcode/wdata-update.R')
```

```{r covid19time, echo=FALSE}
sidebarLayout(
  sidebarPanel(
  radioButtons("data", "Dado de COVID a ser visualizado:",
               c("Casos confirmados" = 1,
                 "Obitos" = 2)),
  selectInput(inputId = 'country', 
              label = 'País', 
              choices = wc.names, 
              selected = 'Brazil'),
  selectInput(inputId = 'state', 
              label = 'Estado/Província', 
              choices = st.names, 
              selected = st.names[1]),
  dateRangeInput('dateRange',
      label = 'Data (intervalo): yyyy-mm-dd',
      start = Sys.Date() - 60, end = Sys.Date() - 1, 
      format = "dd/mm/yy", 
      language = 'pt'
    ),
  checkboxInput("log10", label = "Log 10", value = TRUE),
  actionButton("Exit", "Exit")
), 
renderPlot({
  k <- input$data
  iic <- wdl[[k]]$Country==input$country
  st.names <- unique(as.character(
    wdl[[k]]$Province.State[which(iic)]))
  iis <- wdl[[k]]$Province.State==input$state
  y <- unlist(wdl[[k]][which(iic & iis), 7:ncol(wdl[[k]])])
  dy <- diff(c(0, y))
  r <- dy; r[dy<0] <- 0
  s <- gam(y ~ x, poisson(), list(x=1:length(y), y=r))$fitted
  if (input$log10) {
    yplot <- log(ifelse(dy==0, 0.5, dy), 10)
    splot <- log(s, 10)
  } else {
    yplot <- dy
    splot <- s
  }
  par(mfrow=c(1,1), mar=c(2, 3, 0.1, 0.5), mgp=c(1, 0.5, 0))
  plot(Date, yplot, pch=19, xlab='', ylab=c('Casos', 'Óbotos')[k])
  lines(Date, splot, lwd=2)
}, 
width = 500, heigth=500)
)
```
